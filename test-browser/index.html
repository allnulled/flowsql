<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initializedial-scale=1.0">
    <title>FlowsqlBrowser Test</title>
</head>

<body>
    <script src="qunit.min.js"></script>
    <link rel="stylesheet"
        href="qunit.min.css">
    <script src="sql-wasm.js"></script>
    <script src="flowsql-browser.js"></script>
    <div id="qunit"></div>
    <script>
        const Tests = {};
        Tests.SchemaCRUDAPI = async function (assert) {
            assert.ok(typeof FlowsqlBrowser === "function", "«FlowsqlBrowser» must be a function");
            const flowsqlBrowser = FlowsqlBrowser.create({ trace: false, traceSql: false });
            assert.ok(flowsqlBrowser instanceof FlowsqlBrowser, "«flowsqlBrowser» must be instance of «FlowsqlBrowser»");
            await flowsqlBrowser.connect();
            assert.ok(typeof flowsqlBrowser.$schema.tables === "object", "«flowsqlBrowser.$schema.tables» must be an object");
            assert.ok(typeof flowsqlBrowser.$database === "object", "«flowsqlBrowser.$database» must be an object");
            flowsqlBrowser.addTable("Tabla_1", {
                columns: {
                    name: { type: "string", maxLength: 255, unique: true, label: true },
                    position_x: { type: "real" },
                    position_y: { type: "real" },
                    position_z: { type: "real" },
                }
            });
            flowsqlBrowser.addTable("Tabla_2", {
                columns: {
                    name: { type: "string", maxLength: 255, unique: true, label: true },
                    position_x: { type: "real" },
                    position_y: { type: "real" },
                    position_z: { type: "real" },
                }
            });
            flowsqlBrowser.addTable("Tabla_3", {
                columns: {
                    name: { type: "string", maxLength: 255, unique: true, label: true },
                    position_x: { type: "real" },
                    position_y: { type: "real" },
                    position_z: { type: "real" },
                }
            });
            flowsqlBrowser.addTable("Tabla_4", {
                columns: {
                    name: { type: "string", maxLength: 255, unique: true, label: true },
                    position_x: { type: "real" },
                    position_y: { type: "real" },
                    position_z: { type: "real" },
                }
            });
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_1 === "object", "«flowsqlBrowser.$schema.tables.Tabla_1» must be an object");
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_2 === "object", "«flowsqlBrowser.$schema.tables.Tabla_2» must be an object");
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_3 === "object", "«flowsqlBrowser.$schema.tables.Tabla_3» must be an object");
            flowsqlBrowser.addColumn("Tabla_1", "color", { type: "string", maxLength: 255 });
            flowsqlBrowser.addColumn("Tabla_2", "color", { type: "string", maxLength: 255 });
            flowsqlBrowser.addColumn("Tabla_3", "color", { type: "string", maxLength: 255 });
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_1.columns.color === "object", "«flowsqlBrowser.$schema.tables.Tabla_1.columns.color» must be an object");
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_2.columns.color === "object", "«flowsqlBrowser.$schema.tables.Tabla_2.columns.color» must be an object");
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_3.columns.color === "object", "«flowsqlBrowser.$schema.tables.Tabla_3.columns.color» must be an object");
            flowsqlBrowser.renameTable("Tabla_4", "Tabla_4_modificada");
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_4_modificada === "object", "«flowsqlBrowser.$schema.tables.Tabla_4_modificada» must be an object");
            flowsqlBrowser.renameColumn("Tabla_1", "color", "color_1");
            flowsqlBrowser.renameColumn("Tabla_2", "color", "color_1");
            flowsqlBrowser.renameColumn("Tabla_3", "color", "color_1");
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_1.columns.color_1 === "object", "«flowsqlBrowser.$schema.tables.Tabla_1.columns.color_1» must be an object");
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_2.columns.color_1 === "object", "«flowsqlBrowser.$schema.tables.Tabla_2.columns.color_1» must be an object");
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_3.columns.color_1 === "object", "«flowsqlBrowser.$schema.tables.Tabla_3.columns.color_1» must be an object");
            flowsqlBrowser.dropTable("Tabla_4_modificada");
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_4_modificada === "undefined", "«flowsqlBrowser.$schema.tables.Tabla_4_modificada» must be an undefined");
            flowsqlBrowser.dropColumn("Tabla_1", "color_1");
            flowsqlBrowser.dropColumn("Tabla_2", "color_1");
            flowsqlBrowser.dropColumn("Tabla_3", "color_1");
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_1.columns.color_1 === "undefined", "«flowsqlBrowser.$schema.tables.Tabla_1.columns.color_1» must be an undefined");
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_2.columns.color_1 === "undefined", "«flowsqlBrowser.$schema.tables.Tabla_2.columns.color_1» must be an undefined");
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_3.columns.color_1 === "undefined", "«flowsqlBrowser.$schema.tables.Tabla_3.columns.color_1» must be an undefined");
        };
        Tests.DataCRUDAPI = async function (assert) {
            assert.ok(typeof FlowsqlBrowser === "function", "«FlowsqlBrowser» must be a function");
            const flowsqlBrowser = FlowsqlBrowser.create({ trace: false, traceSql: false });
            assert.ok(flowsqlBrowser instanceof FlowsqlBrowser, "«flowsqlBrowser» must be instance of «FlowsqlBrowser»");
            await flowsqlBrowser.connect();
            assert.ok(typeof flowsqlBrowser.$schema.tables === "object", "«flowsqlBrowser.$schema.tables» must be an object");
            assert.ok(typeof flowsqlBrowser.$database === "object", "«flowsqlBrowser.$database» must be an object");
            flowsqlBrowser.addTable("Tabla_1", {
                columns: {
                    name: { type: "string", maxLength: 255, unique: true, label: true },
                    position_x: { type: "real" },
                    position_y: { type: "real" },
                    position_z: { type: "real" },
                }
            });
            flowsqlBrowser.addTable("Tabla_2", {
                columns: {
                    name: { type: "string", maxLength: 255, unique: true, label: true },
                    position_x: { type: "real" },
                    position_y: { type: "real" },
                    position_z: { type: "real" },
                }
            });
            flowsqlBrowser.addTable("Tabla_3", {
                columns: {
                    name: { type: "string", maxLength: 255, unique: true, label: true },
                    position_x: { type: "real" },
                    position_y: { type: "real" },
                    position_z: { type: "real" },
                }
            });
            flowsqlBrowser.addTable("Tabla_4", {
                columns: {
                    name: { type: "string", maxLength: 255, unique: true, label: true },
                    position_x: { type: "real" },
                    position_y: { type: "real" },
                    position_z: { type: "real" },
                }
            });
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_1 === "object", "«flowsqlBrowser.$schema.tables.Tabla_1» must be an object");
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_2 === "object", "«flowsqlBrowser.$schema.tables.Tabla_2» must be an object");
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_3 === "object", "«flowsqlBrowser.$schema.tables.Tabla_3» must be an object");
            const ids = flowsqlBrowser.insertMany("Tabla_1", [{
                name: "unique1",
                position_x: 10.01,
                position_y: 20.02,
                position_z: 30.03,
            }, {
                name: "unique2",
                position_x: 210.01,
                position_y: 220.02,
                position_z: 230.03,
            }, {
                name: "unique3",
                position_x: 510.01,
                position_y: 520.02,
                position_z: 530.03,
            }]);
            assert.ok(Array.isArray(ids), "«flowsqlBrowser.insertMany» must return an array");
            assert.ok(ids.length === 3, "«flowsqlBrowser.insertMany» must return an array of 3 items");
            const all1 = flowsqlBrowser.selectMany("Tabla_1", []);
            assert.ok(Array.isArray(all1), "«flowsqlBrowser.selectMany» must return basic format");
            assert.ok(all1.length === 3, "«flowsqlBrowser.selectMany» must return 3 recently inserted rows");
            flowsqlBrowser.updateMany("Tabla_3", [
                ["id", "is in", [1, 2]]
            ], {
                position_x: 0
            });
            const all2 = flowsqlBrowser.selectMany("Tabla_1", [
                ["id", "is in", [1, 2]]
            ]);
            assert.ok(Array.isArray(all2), "«flowsqlBrowser.selectMany» must return basic format");
            assert.ok(all2.length === 2, "«flowsqlBrowser.selectMany» must return 2 recently inserted rows");
            assert.ok(all2[0].id === 1, "«flowsqlBrowser.selectMany» must return «all2[0].id» as 1");
            assert.ok(all2[1].id === 2, "«flowsqlBrowser.selectMany» must return «all2[1].id» as 2");
            flowsqlBrowser.deleteMany("Tabla_1", [["id", "is not in", [1, 2]]]);
            const all3 = flowsqlBrowser.selectMany("Tabla_1", []);
            assert.ok(Array.isArray(all3), "«flowsqlBrowser.selectMany» must return basic format");
            assert.ok(all3.length === 2, "«flowsqlBrowser.selectMany» must return 2 rows");
        };
        Tests.PersistenceAPI = async function (assert) {
            assert.ok(typeof FlowsqlBrowser === "function", "«FlowsqlBrowser» must be a function");
            const flowsqlBrowser = FlowsqlBrowser.create({ trace: false, traceSql: false });
            assert.ok(flowsqlBrowser instanceof FlowsqlBrowser, "«flowsqlBrowser» must be instance of «FlowsqlBrowser»");
            await flowsqlBrowser.connect();
            assert.ok(typeof flowsqlBrowser.$schema.tables === "object", "«flowsqlBrowser.$schema.tables» must be an object");
            assert.ok(typeof flowsqlBrowser.$database === "object", "«flowsqlBrowser.$database» must be an object");
            flowsqlBrowser.addTable("Tabla_1", {
                columns: {
                    name: { type: "string", maxLength: 255, unique: true, label: true },
                    position_x: { type: "real" },
                    position_y: { type: "real" },
                    position_z: { type: "real" },
                }
            });
            flowsqlBrowser.addTable("Tabla_2", {
                columns: {
                    name: { type: "string", maxLength: 255, unique: true, label: true },
                    position_x: { type: "real" },
                    position_y: { type: "real" },
                    position_z: { type: "real" },
                }
            });
            flowsqlBrowser.addTable("Tabla_3", {
                columns: {
                    name: { type: "string", maxLength: 255, unique: true, label: true },
                    position_x: { type: "real" },
                    position_y: { type: "real" },
                    position_z: { type: "real" },
                }
            });
            flowsqlBrowser.addTable("Tabla_4", {
                columns: {
                    name: { type: "string", maxLength: 255, unique: true, label: true },
                    position_x: { type: "real" },
                    position_y: { type: "real" },
                    position_z: { type: "real" },
                }
            });
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_1 === "object", "«flowsqlBrowser.$schema.tables.Tabla_1» must be an object");
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_2 === "object", "«flowsqlBrowser.$schema.tables.Tabla_2» must be an object");
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_3 === "object", "«flowsqlBrowser.$schema.tables.Tabla_3» must be an object");
            const ids = flowsqlBrowser.insertMany("Tabla_1", [{
                name: "unique1",
                position_x: 10.01,
                position_y: 20.02,
                position_z: 30.03,
            }, {
                name: "unique2",
                position_x: 210.01,
                position_y: 220.02,
                position_z: 230.03,
            }, {
                name: "unique3",
                position_x: 510.01,
                position_y: 520.02,
                position_z: 530.03,
            }]);
            assert.ok(Array.isArray(ids), "«flowsqlBrowser.insertMany» must return an array");
            assert.ok(ids.length === 3, "«flowsqlBrowser.insertMany» must return an array of 3 items");
            const exportation = flowsqlBrowser.dehydrate();
            assert.ok(typeof exportation === "string", "«exportation» must be a string");
            const flowsqlBrowser2 = FlowsqlBrowser.create({});
            flowsqlBrowser2.hydrate(flowsqlBrowser.dehydrate());
            assert.ok(typeof flowsqlBrowser2.$schema.tables.Tabla_1 === "object", "«flowsqlBrowser.$schema.tables.Tabla_1» must be an object");
            assert.ok(typeof flowsqlBrowser2.$schema.tables.Tabla_2 === "object", "«flowsqlBrowser.$schema.tables.Tabla_2» must be an object");
            assert.ok(typeof flowsqlBrowser2.$schema.tables.Tabla_3 === "object", "«flowsqlBrowser.$schema.tables.Tabla_3» must be an object");
            const allT1 = flowsqlBrowser2.selectMany("Tabla_1");
            assert.ok(allT1.length === 3, "«allT1.length» must be 3");
        };

        Tests.DataProxyAPI = async function (assert) {
            assert.ok(typeof FlowsqlBrowser === "function", "«FlowsqlBrowser» must be a function");
            const flowsqlBrowser = FlowsqlBrowser.create({ trace: false, traceSql: false });
            assert.ok(flowsqlBrowser instanceof FlowsqlBrowser, "«flowsqlBrowser» must be instance of «FlowsqlBrowser»");
            await flowsqlBrowser.connect();
            assert.ok(typeof flowsqlBrowser.$schema.tables === "object", "«flowsqlBrowser.$schema.tables» must be an object");
            assert.ok(typeof flowsqlBrowser.$database === "object", "«flowsqlBrowser.$database» must be an object");
            flowsqlBrowser.addTable("Tabla_1", {
                columns: {
                    name: { type: "string", maxLength: 255, unique: true, label: true },
                    position_x: { type: "real" },
                    position_y: { type: "real" },
                    position_z: { type: "real" },
                }
            });
            flowsqlBrowser.addTable("Tabla_2", {
                columns: {
                    name: { type: "string", maxLength: 255, unique: true, label: true },
                    position_x: { type: "real" },
                    position_y: { type: "real" },
                    position_z: { type: "real" },
                }
            });
            flowsqlBrowser.addTable("Tabla_3", {
                columns: {
                    name: { type: "string", maxLength: 255, unique: true, label: true },
                    position_x: { type: "real" },
                    position_y: { type: "real" },
                    position_z: { type: "real" },
                }
            });
            flowsqlBrowser.addTable("Tabla_4", {
                columns: {
                    name: { type: "string", maxLength: 255, unique: true, label: true },
                    position_x: { type: "real" },
                    position_y: { type: "real" },
                    position_z: { type: "real" },
                }
            });
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_1 === "object", "«flowsqlBrowser.$schema.tables.Tabla_1» must be an object");
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_2 === "object", "«flowsqlBrowser.$schema.tables.Tabla_2» must be an object");
            assert.ok(typeof flowsqlBrowser.$schema.tables.Tabla_3 === "object", "«flowsqlBrowser.$schema.tables.Tabla_3» must be an object");

            const dataproxy1 = flowsqlBrowser.createDataProxy([]);

            assert.ok(typeof dataproxy1 === "object", "«dataproxy1» must be an object");
            assert.ok(typeof dataproxy1.$memory === "object", "«dataproxy1.$memory» must be an object");
            assert.ok(typeof dataproxy1.$dataset === "object", "«dataproxy1.$dataset» must be an object");

            assert.ok(typeof dataproxy1.filterByEval === "function", "«dataproxy1.filterByEval» must be an function");
            assert.ok(typeof dataproxy1.mapByEval === "function", "«dataproxy1.mapByEval» must be an function");
            assert.ok(typeof dataproxy1.reduceByEval === "function", "«dataproxy1.reduceByEval» must be an function");
            assert.ok(typeof dataproxy1.modifyByEval === "function", "«dataproxy1.modifyByEval» must be an function");
            assert.ok(typeof dataproxy1.amplifyByEval === "function", "«dataproxy1.amplifyByEval» must be an function");
            assert.ok(typeof dataproxy1.groupByEvals === "function", "«dataproxy1.groupByEvals» must be an function");

            assert.ok(typeof dataproxy1.memorize === "function", "«dataproxy1.memorize» must be an function");
            assert.ok(typeof dataproxy1.remember === "function", "«dataproxy1.remember» must be an function");
            assert.ok(typeof dataproxy1.byMatrix === "function", "«dataproxy1.byMatrix» must be an function");
        };

        Tests.FileSystemAPI = async function (assert) {
            assert.ok(typeof FlowsqlBrowser === "function", "«FlowsqlBrowser» must be a function");
            ////////////////////////////////////////////////////////////////////
            const flowsqlBrowser = FlowsqlBrowser.create({ trace: true, traceSql: true });
            window.flowsqlBrowser = flowsqlBrowser;
            assert.ok(flowsqlBrowser instanceof FlowsqlBrowser, "«flowsqlBrowser» must be instance of «FlowsqlBrowser»");
            await flowsqlBrowser.connect();
            assert.ok(typeof flowsqlBrowser.$schema.tables === "object", "«flowsqlBrowser.$schema.tables» must be an object");
            assert.ok(typeof flowsqlBrowser.$database === "object", "«flowsqlBrowser.$database» must be an object");
            ////////////////////////////////////////////////////////////////////
            const filesystem1 = flowsqlBrowser.createFileSystem("Database_files");
            window.filesystem1 = filesystem1;
            assert.ok(typeof filesystem1 === "object", "«filesystem1» must be an object");
            filesystem1.writeFile("fichero1.txt", "Contenido!");
            filesystem1.writeDirectory("folder1");
            filesystem1.writeDirectory("folder1/carpeta1");
            const list1 = filesystem1.readDirectory("/");
            assert.ok(Array.isArray(list1), "«list1» must be an array");
            assert.ok(list1.length === 2, "«list1.length» must be 2");
            const content1 = filesystem1.readFile("/fichero1.txt");
            assert.ok(typeof content1 === "string", "«content1» must be a string");
            assert.ok(content1 === "Contenido!", "«content1» must be 'Contenido!'");
            filesystem1.removeFile("/fichero1.txt");
            filesystem1.removeDirectory("/folder1");
            const list2 = filesystem1.readDirectory("/");
            assert.ok(Array.isArray(list2), "«list2» must be an array");
            assert.ok(list2.length === 0, "«list2.length» must be 0");
            const list3 = filesystem1.readDirectory("/folder1");
            assert.ok(Array.isArray(list3), "«list3» must be an array");
            assert.ok(list3.length === 1, "«list3.length» must be 1");
            assert.ok(list3[0].node_path === "/folder1/carpeta1", "«list3[0].node_path» must be '/folder1/carpeta1'");
            filesystem1.renameDirectory("/folder1/carpeta1", "/carpeta0001");
            filesystem1.writeFile("/folder1/fichero1.txt", "ok");
            filesystem1.renameFile("/folder1/fichero1.txt", "/fichero0001.txt");
            const list4 = filesystem1.readDirectory("/");
            assert.ok(Array.isArray(list4), "«list4» must be an array");
            assert.ok(list4.length === 2, "«list4.length» must be 2");
        };
        Tests.QueryAPI = async function (assert) {
            assert.ok(typeof FlowsqlBrowser.Query === "function", "«FlowsqlBrowser.Query» must be a function");
        };
        Tests.ClientAPI = async function (assert) {
            assert.ok(typeof FlowsqlBrowser.Client === "function", "«FlowsqlBrowser.Client» must be a function");
        };
        Tests.ServerAPI = async function (assert) {
            assert.ok(typeof FlowsqlBrowser.Server === "function", "«FlowsqlBrowser.Server» must be a function");
        };
        Tests.FirewallAPI = async function (assert) {
            assert.ok(typeof FlowsqlBrowser.Firewall === "function", "«FlowsqlBrowser.Firewall» must be a function");
        };
        Tests.FirewallParserAPI = async function (assert) {
            assert.ok(typeof FirewallParser === "object", "«FirewallParser» must be an object");
            assert.ok(typeof FirewallParser.parse === "function", "«FirewallParser» must be a function");
        };
    </script>
    <script>

        QUnit.config.autostart = false;
        window.addEventListener("load", async () => {
            try {
                QUnit.module("FlowsqlBrowser API", async function () {
                    QUnit.test("Test de Schema CRUD API", Tests.SchemaCRUDAPI);
                    QUnit.test("Test de Data CRUD API", Tests.DataCRUDAPI);
                    QUnit.test("Test de Persistence API", Tests.PersistenceAPI);
                    QUnit.test("Test de DataProxy API", Tests.DataProxyAPI);
                    QUnit.test("Test de FileSystem API", Tests.FileSystemAPI);
                    QUnit.test("Test de Query API", Tests.QueryAPI);
                    QUnit.test("Test de Client API", Tests.ClientAPI);
                    QUnit.test("Test de Server API", Tests.ServerAPI);
                    QUnit.test("Test de Firewall API", Tests.FirewallAPI);
                    QUnit.test("Test de FirewallParser API", Tests.FirewallParserAPI);
                });
                QUnit.start();
            } catch (error) {
                console.log(error);
            }
        });
    </script>
</body>

</html>